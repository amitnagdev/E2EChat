'use strict';

/***********************************
 *** START ~ Module dependencies ***
 ***********************************/

// Global dependencies
const _ = require('lodash'),
    S = require('string');

// Project dependencies


/***********************************
 *** END ~ Module dependencies ***
 ***********************************/

exports.initRequest = (config) => (req, res, next) => {
    let www = 'www.';
    if (S(req.hostname).toLowerCase().startsWith(www)) {
        let hostname = req.hostname.substring(www.length);
        let protocol = (config.ssl && config.ssl.active ? 'https' : 'http');
        res.redirect(protocol + '://' + hostname + ':' + config.port + req.path);
    } else {
        req.uri = req.protocol + '://' + req.get('host');
        req.isSecure = req.protocol === 'https';

        if (req.ip) {
            req.ipAddress = req.ip.replace('::ffff:', '');
        }

        next();
    }
};